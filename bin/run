#!/usr/bin/env ruby

require 'action_cable_client'

GPIO_UTIL_PATH = '/home/mackinleysmith/pi-actioncable-testing/bin/gpio_util'

EventMachine.run do

  uri = 'ws://localhost:3000/cable'
  client = ActionCableClient.new(uri, 'GpioOutputsChannel')
  # the connected callback is required, as it triggers
  # the actual subscribing to the channel but it can just be
  # client.connected {}
  client.connected { puts 'successfully connected.' }
  client.subscribed do
    puts 'subscribed.'
    client.perform('follow', {})
  end

  # called whenever a message is received from the server
  client.received do |msg|
    puts "Message received: #{msg}"
    gpio_output = msg['message']['gpio_output']
    `sudo #{GPIO_UTIL_PATH} -p #{gpio_output['pin']} #{gpio_output['value']}`
  end
  client.errored  {|msg| puts msg }

  client.disconnected { puts 'disconnected.' }

  # adds to a queue that is purged upon receiving of
  # a ping from the server
  # client.perform('speak', { message: 'hello from amc' })
end
